{
  "hash": "6881881491668b05c0a93e9912554615",
  "result": {
    "markdown": "---\ntalk-title: \"Forecasting with `{epipredict}`\"\ntalk-short-title: \"{{< meta talk-title >}}\"\ntalk-subtitle: \"\"\nauthor: \"\"\nother-authors: \"\"\nrepo-address: \"cmu-delphi/insightnet-workshop-2024\"\ntalk-date: \"Venue -- dd Somemonth yyyy\"\nformat: revealjs\nexecute:\n  cache: true\n---\n\n\n<!-- Set any of the above to \"\" to omit them -->\n\n<!-- Or adjust the formatting in _titleslide.qmd -->\n---\n---\n\n\\DeclareMathOperator*{\\minimize}{minimize}\n\n\n\n\n\n\n\n::: flex\n::: w-20\n\n:::\n::: w-80\n## {{< meta talk-title >}} {background-image=\"gfx/cover-art-1.svg\" background-position=\"bottom\"}\n\n### {{< meta talk-subtitle >}}\n\n<br>\n\n#### {{< meta author >}} \n{{< meta other-authors >}}\n\n{{< meta talk-date >}}\n:::\n:::\n\n\n\n\n<style>\n.scrollable-output {\n  max-height: 500px; /* Adjust the height as needed */\n  overflow-y: auto;  /* Enables vertical scrolling */\n}\n</style>\n\n<style>\n.inner-list {\n  font-size: 0.85em; /* Adjust size as needed */\n}\n</style>\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/theme_ecd10d94a73734898a3472357338ab74'}\n\n:::\n\n\n## Outline\n\n1. `{epipredict}`\n\n1. Fit and Predict with `arx_forecaster`\n\n1. Customizing `arx_forecaster`\n\n1. Forecasting with Versioned Data\n\n1. Building a Forecaster\n\n# `{epipredict}` \n\n## `{epipredict}` \n\n<https://cmu-delphi.github.io/epipredict>\n\n#### Installation \n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/install_31b62ac0e9710a55bdc15cbf44d2d2f9'}\n\n```{.r .cell-code}\n# Stable version\npak::pkg_install(\"cmu-delphi/epipredict@main\")\n# Development version\n# pak::pkg_install(\"cmu-delphi/epipredict@dev\")\n```\n:::\n\n\n\n## What `{epipredict}` provides (i)\n\nBasic and easy to use [\"canned\" forecasters]{.primary}: \n\n  * Baseline flat forecaster\n  \n  * Autoregressive forecaster (ARX)\n  \n  * Autoregressive classifier\n  \n  * CDC FluSight flatline forecaster\n  \n## What `{epipredict}` provides (ii)\n\n* A framework for creating [custom forecasters]{.primary} out of [modular]{.primary} components. \n\n* There are four types of components:\n\n  1. [Preprocessor]{.primary}: do things to the data before model training\n  \n  1. [Trainer]{.primary}: train a model on data, resulting in a fitted model object\n\n  1. [Predictor]{.primary}: make predictions, using a fitted model object\n\n  1. [Postprocessor]{.primary}: do things to the predictions before returning\n  \n\n# Fit and Predict with `arx_forecaster`\n\n## Fit ARX on training set\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/libraries and data_08c2b526f67ec4de22f99ae2c39f14c0'}\n\n:::\n\n\n* Back to the ARX model for COVID deaths:\n$\\quad \\hat y_{t+28} = \\hat\\phi + \\hat\\phi_0 y_{t} + \\hat\\beta_0 x_{t}$\n\n* Using `{epipredict}`\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epipredict-arx_76fe1819adf8693a6264987eb3ab9141'}\n\n```{.r .cell-code  code-line-numbers=\"|8-14\"}\nlibrary(epipredict)\n\n# split into train and test \nt0_date <- as.Date('2021-04-01')\ntrain <- ca |> filter(time_value <= t0_date)\ntest <- ca |> filter(time_value > t0_date)\n\n# fit ARX\nepi_arx <- arx_forecaster(epi_data = train |> as_epi_df(), \n                          outcome = \"deaths\", \n                          predictors = c(\"cases\", \"deaths\"),\n                          trainer = linear_reg() |> set_engine(\"lm\"),\n                          args_list = arx_args_list(lags = 0, ahead = 28,\n                                                    quantile_levels = c(0.1, 0.9)))\n```\n:::\n\n\n## `arx_forecaster` output\n\n* A [fitted model]{.primary} object which can be used any time in the future to create forecasts (`$epi_workflows`).\n\n* A [forecast]{.primary} (point prediction + interval) \nfor 28 days after the last available time value in the data (`$predictions`).\n\n\n## `arx_forecaster` output\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/output-arx_b311982f813644d002e71ff04d223acb'}\n\n```{.r .cell-code}\nepi_arx \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n══ A basic forecaster of type ARX Forecaster ═══════════════════════════════════\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThis forecaster was fit on 2024-11-12 08:50:39.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nTraining data was an <epi_df> with:\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• Geography: state,\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• Other keys: ,\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• Time type: day,\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• Using data up-to-date as of: 2024-11-06 08:50:44.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• With the last data available on 2021-04-01\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Predictions ─────────────────────────────────────────────────────────────────\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nA total of 1 prediction is available for\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• 1 unique geographic region,\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• At forecast date: 2021-04-01,\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n• For target date: 2021-04-29,\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n:::\n\n\n\n## Extract fitted object\n\n<div class=\"scrollable-output\">\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epi-workflow-arx_e507248819bdd7c55d84f0df28fe9e86'}\n\n```{.r .cell-code}\nepi_arx$epi_workflow\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n══ Epi Workflow [trained] ══════════════════════════════════════════════════════\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nPreprocessor: Recipe\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nModel: linear_reg()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nPostprocessor: Frosting\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Preprocessor ────────────────────────────────────────────────────────────────\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n6 Recipe steps.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n1. step_epi_lag()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n2. step_epi_lag()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n3. step_epi_ahead()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n4. step_naomit()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n5. step_naomit()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n6. step_training_window()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Model ───────────────────────────────────────────────────────────────────────\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nstats::lm(formula = ..y ~ ., data = data)\n\nCoefficients:\n (Intercept)   lag_0_cases  lag_0_deaths  \n    0.076884      0.009858      0.200700  \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Postprocessor ───────────────────────────────────────────────────────────────\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n5 Frosting layers.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n1. layer_predict()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n2. layer_residual_quantiles()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n3. layer_add_forecast_date()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n4. layer_add_target_date()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n5. layer_threshold()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n:::\n\n\n</div>\n\n## Extract predictions\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epi-pred-arx_43331ea99d1bd2a1364e1cb26a52cc55'}\n\n```{.r .cell-code}\nepi_arx$predictions\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 5\n  geo_value .pred        .pred_distn forecast_date target_date\n  <chr>     <dbl>             <dist> <date>        <date>     \n1 ca        0.219 quantiles(0.22)[2] 2021-04-01    2021-04-29 \n```\n:::\n:::\n\n\n::: {.callout-important icon=\"false\"}\n## Note \n\n`.pred_dstn` is actually a “distribution”, parameterized by its quantiles. \n:::\n\n\n## Extract predictions\n\nWe can extract the distribution into a “long” `epi_df`: \n\n* <span class=\"inner-list\"> one row per quantile </span>\n\n* <span class=\"inner-list\">`values` = value associated to that quantile</span>\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epi-pred-arx-unnest_d4fa8230f21b34c968c84806601cf647'}\n\n```{.r .cell-code}\nepi_arx$predictions |>\n  mutate(.pred_distn = nested_quantiles(.pred_distn)) |>  # create a \"nested\" list-column\n  unnest(.pred_distn)                                     # then unnest it\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 6\n  geo_value .pred values quantile_levels forecast_date target_date\n  <chr>     <dbl>  <dbl>           <dbl> <date>        <date>     \n1 ca        0.219 0.0133           0.025 2021-04-01    2021-04-29 \n2 ca        0.219 0.425            0.975 2021-04-01    2021-04-29 \n```\n:::\n:::\n\n\n\n## Predict with fitted ARX (split-sample)\n\n* `arx_forecaster` fits a model to the training set, and outputs only one prediction (for time $t_0+h$).\n\n* To get [predictions]{.primary} for the [test]{.primary} set:\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/arx-test-predict_72ce8500b03398a5db44ed3744123776'}\n\n```{.r .cell-code}\npredict(epi_arx$epi_workflow, test)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn `epi_df` object, 707 x 6 with metadata:\n* geo_type  = state\n* time_type = day\n* as_of     = 2024-11-06 08:50:44.00687\n\n# A tibble: 707 × 6\n   geo_value time_value .pred        .pred_distn forecast_date target_date\n * <chr>     <date>     <dbl>             <dist> <date>        <date>     \n 1 ca        2021-04-02 0.217 quantiles(0.22)[2] 2021-04-01    2021-04-29 \n 2 ca        2021-04-03 0.203  quantiles(0.2)[2] 2021-04-01    2021-04-29 \n 3 ca        2021-04-04 0.197  quantiles(0.2)[2] 2021-04-01    2021-04-29 \n 4 ca        2021-04-05 0.202  quantiles(0.2)[2] 2021-04-01    2021-04-29 \n 5 ca        2021-04-06 0.199  quantiles(0.2)[2] 2021-04-01    2021-04-29 \n 6 ca        2021-04-07 0.196  quantiles(0.2)[2] 2021-04-01    2021-04-29 \n 7 ca        2021-04-08 0.193 quantiles(0.19)[2] 2021-04-01    2021-04-29 \n 8 ca        2021-04-09 0.195  quantiles(0.2)[2] 2021-04-01    2021-04-29 \n 9 ca        2021-04-10 0.209 quantiles(0.21)[2] 2021-04-01    2021-04-29 \n10 ca        2021-04-11 0.214 quantiles(0.21)[2] 2021-04-01    2021-04-29 \n# ℹ 697 more rows\n```\n:::\n:::\n\n\n## Predict with ARX (when re-fitting)\n\nIn practice, if we want to [re-train]{.primary} the forecasters as [new data]{.primary} arrive,\nwe fit and predict combining `arx_forecaster` with `epi_slide`.\n\n\n## Predict with ARX (re-fitting on trailing window)\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epipredict-cv-trailing_552d4d66b9b1159bf0aaf04f716f7edb'}\n\n```{.r .cell-code}\nh <- 28         #horizon\nw <- 120 + h    #trailing window length\nn <- nrow(ca)   #time-series length\n\n# Specify the forecast dates\nfc_time_values <- seq(from = t0_date, to = ca$time_value[n]-h, by = \"1 day\")\n\n# Slide the arx_forecaster \nepi_pred_trailing <- ca |>\n  epi_slide(\n    ~ arx_forecaster(epi_data = .x,\n                     outcome = \"deaths\", \n                     predictors = c(\"cases\", \"deaths\"), \n                     trainer = linear_reg() |> set_engine(\"lm\"),\n                     args_list = arx_args_list(lags = 0, ahead = h,\n                                               quantile_levels = c(0.01, 0.9))\n                     )$predictions |>\n        pivot_quantiles_wider(.pred_distn),\n  .window_size = w, \n  .ref_time_values = fc_time_values\n)\n```\n:::\n\n\n## Predict with ARX \n\n::: {.callout-important icon=\"false\"}\n## Note (window length)\n\nWe set $w = 120 + h$ to match the window size of the ARX model we fitted manually.\nPreviously, when considering a window from $t-w$ to $t$, \nwe had access to all outcomes in that window, and to all predictors between \n$t-w-h$ and $t-h$. \n(That's because we lagged $x$ before applying the window.) \nSo we were \"cheating\" by saying that \nthe trailing window had length $w=120$, as its actual size was $120+h$! \n:::\n  \n::: {.callout-important icon=\"false\"}\n## Note (all past)\n\nThe method [fitting on all past data]{.primary} up to the forecasting date can be \nimplemented by setting:\n\n`.window_size = Inf` in `epi_slide`.\n:::\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epipredict-cv_3dc6859f4dd74a8e06a4c2cd590b774b'}\n\n:::\n\n\n\n## Predict with ARX (re-fitting on trailing window)\n\n<div class=\"large-output\">\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epipredict-cv-trailing-head_9a4f04f8b3a9b03be097437824a446a5'}\n\n```{.r .cell-code}\nepi_pred_trailing \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn `epi_df` object, 680 x 9 with metadata:\n* geo_type  = state\n* time_type = day\n* as_of     = 2024-11-06 08:50:44.00687\n\n# A tibble: 680 × 9\n# Groups:   geo_value [1]\n   geo_value time_value cases deaths .pred forecast_date target_date `0.025`\n * <chr>     <date>     <dbl>  <dbl> <dbl> <date>        <date>        <dbl>\n 1 ca        2021-04-01  6.77  0.375 0.337 2021-04-01    2021-04-29   0.0996\n 2 ca        2021-04-02  7.27  0.340 0.340 2021-04-02    2021-04-30   0.104 \n 3 ca        2021-04-03  6.79  0.293 0.331 2021-04-03    2021-05-01   0.0960\n 4 ca        2021-04-04  6.51  0.281 0.327 2021-04-04    2021-05-02   0.0919\n 5 ca        2021-04-05  6.87  0.284 0.330 2021-04-05    2021-05-03   0.0934\n 6 ca        2021-04-06  6.97  0.267 0.329 2021-04-06    2021-05-04   0.0900\n 7 ca        2021-04-07  6.92  0.253 0.326 2021-04-07    2021-05-05   0.0850\n 8 ca        2021-04-08  6.97  0.234 0.322 2021-04-08    2021-05-06   0.0795\n 9 ca        2021-04-09  7.07  0.243 0.322 2021-04-09    2021-05-07   0.0784\n10 ca        2021-04-10  8.33  0.249 0.332 2021-04-10    2021-05-08   0.0878\n# ℹ 670 more rows\n# ℹ 1 more variable: `0.975` <dbl>\n```\n:::\n:::\n\n\n</div>\n\n## Predict with ARX (re-fitting on trailing window)\n\n\n::: {.cell layout-align=\"left\" hash='day2-afternoon_cache/revealjs/arx-plot-cv-predictions_bc0eccbb491b73d95e36ea6f2a4f37a8'}\n::: {.cell-output-display}\n![](day2-afternoon_files/figure-revealjs/arx-plot-cv-predictions-1.svg){fig-align='left'}\n:::\n:::\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/function errors_d9d82e4aa282949ac1dc379f297ae096'}\n\n:::\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/error-arx_dc9072770b6aad9d4543e97a4785eff1'}\n::: {.cell-output .cell-output-stdout}\n```\n                                 MAE     MASE\ntime series CV + trailing 0.07852942 731.6178\n```\n:::\n:::\n\n\n\n# Customizing `arx_forecaster`\n\n## Simple adjustments\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/print-model-1_a3dd3bf68bd012ed7c42f2a99eb0b322'}\n\n```{.r .cell-code  code-line-numbers=\"|3\"}\narx_forecaster(epi_data = train |> as_epi_df(), \n               outcome = \"deaths\", \n               predictors = c(\"cases\", \"deaths\"),\n               trainer = linear_reg() |> set_engine(\"lm\"),\n               args_list = arx_args_list(lags = 0, ahead = 28,\n                                         quantile_levels = c(0.01, 0.9)))\n```\n:::\n\n\n::: {.fragment .fade-in}\n* Modify `predictors` to add/drop predictors \n\n  * <span class=\"inner-list\">e.g. drop `deaths` for regression with a \n  lagged predictor, or drop `cases` to get AR model</span>\n\n  * <span class=\"inner-list\">default: `predictors = outcome`</span>\n\n:::  \n  \n## Simple adjustments\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/print-model-2_0cc5c4d4ea6f7331b91a6b81489b5b8b'}\n\n```{.r .cell-code  code-line-numbers=\"4\"}\narx_forecaster(epi_data = train |> as_epi_df(), \n               outcome = \"deaths\", \n               predictors = c(\"cases\", \"deaths\"),\n               trainer = linear_reg() |> set_engine(\"lm\"),\n               args_list = arx_args_list(lags = 0, ahead = 28,\n                                         quantile_levels = c(0.01, 0.9)))\n```\n:::\n\n\n* Modify `trainer` to use a model that is not `lm` (default)\n\n  * <span class=\"inner-list\"> e.g. `trainer = quantile_reg()`</span>\n  \n  * <span class=\"inner-list\">can use any `{parsnip}` models, \n  see [list](https://www.tidymodels.org/find/parsnip/)</span>\n  \n   \n\n\n## Simple adjustments\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/print-model-3_e733fef7301c7bb25808b112d4ad2b65'}\n\n```{.r .cell-code  code-line-numbers=\"5-6\"}\narx_forecaster(epi_data = train |> as_epi_df(), \n               outcome = \"deaths\", \n               predictors = c(\"cases\", \"deaths\"),\n               trainer = linear_reg() |> set_engine(\"lm\"),\n               args_list = arx_args_list(lags = 0, ahead = 28,\n                                         quantile_levels = c(0.01, 0.9)))\n```\n:::\n\n\n* Modify `arx_args_list` to change lags, horizon, quantile levels, ...\n\n::: {.fragment .fade-in}\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/arx_args_list_3b91e8e47c679d5b3956ee03bf5eaadc'}\n\n```{.r .cell-code}\narx_args_list(\n  lags = c(0L, 7L, 14L),\n  ahead = 7L,\n  n_training = Inf,\n  forecast_date = NULL,\n  target_date = NULL,\n  adjust_latency = c(\"none\", \"extend_ahead\", \"extend_lags\", \"locf\"),\n  warn_latency = TRUE,\n  quantile_levels = c(0.05, 0.95),\n  symmetrize = TRUE,\n  nonneg = TRUE,\n  quantile_by_key = character(0L),\n  check_enough_data_n = NULL,\n  check_enough_data_epi_keys = NULL,\n  ...\n)\n```\n:::\n\n:::\n\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/get-us-data_3bc177516221e8dfb81e81349f03e6ed'}\n\n:::\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/geo-pool-usa_e0867ba60e56acb60957fa44c2f1158a'}\n\n:::\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/epipredict-cv-trailing-usa_2fee389b438b8007f24ff226b9e78de0'}\n\n:::\n\n\n# Forecasting with Versioned Data\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/get-versioned-data_0fa044deaf86723b884c5f05360cae03'}\n\n:::\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/versioned-weekly-avg_7c74e8116d61a703fe5890d47be30ac8'}\n\n:::\n\n\n## Versioned data\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/print-versioned-data_6fde5da22f3763f9e27b872023107ac0'}\n\n```{.r .cell-code}\nus_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n→ An `epi_archive` object, with metadata:\nℹ Min/max time values: 2020-04-01 / 2023-01-31\nℹ First/last version with update: 2021-04-01 / 2023-02-01\nℹ Versions end: 2023-02-01\nℹ A preview of the table (92197 rows x 5 columns):\n          version time_value geo_value     cases     deaths\n    1: 2021-04-01 2020-04-01        ak        NA         NA\n    2: 2021-04-01 2020-04-02        ak        NA         NA\n    3: 2021-04-01 2020-04-03        ak        NA         NA\n    4: 2021-04-01 2020-04-04        ak        NA         NA\n    5: 2021-04-01 2020-04-05        ak        NA         NA\n   ---                                                     \n92193: 2023-02-01 2023-01-27        wy   4.61203 0.17172453\n92194: 2023-02-01 2023-01-28        wy   4.61203 0.17172453\n92195: 2023-02-01 2023-01-29        wy   4.61203 0.17172453\n92196: 2023-02-01 2023-01-30        wy   4.61203 0.17172453\n92197: 2023-02-01 2023-01-31        wy -14.74378 0.04906416\n```\n:::\n:::\n\n\n## Version-aware forecasting with geo-pooling\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/predict-version-aware_dd45d2a193e4725ad2aadd8f2bf9f4eb'}\n\n```{.r .cell-code  code-line-numbers=\"|5-17\"}\nforecast_dates <- seq(from = t0_date, to = as.Date(\"2023-02-01\"), by = \"1 month\")\nh <- c(7, 14, 21, 28)\n\nforecast_k_days_ahead <- function(epi_archive, forecast_dates, ahead = 7) {\n  epi_archive |>\n    epix_slide(\n      ~ arx_forecaster(\n        .x, \n        outcome = \"deaths\", \n        predictors = c(\"cases\", \"deaths\"),\n        trainer = linear_reg() |> set_engine(\"lm\"),\n        args_list = arx_args_list(lags = 0, ahead = ahead,\n                                  quantile_levels = c(0.01, 0.9))\n      )$predictions |> pivot_quantiles_wider(.pred_distn),\n      .before = 120,\n      .versions = forecast_dates\n    )\n}\n\nforecasts <- bind_rows(map(h, ~ forecast_k_days_ahead(us_data, forecast_dates, ahead = .x)))\n```\n:::\n\n\n## Version-aware forecasting with geo-pooling\n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/plot-version-aware_f38cc92ee2d1f7289bec014edbb20253'}\n::: {.cell-output-display}\n![](day2-afternoon_files/figure-revealjs/plot-version-aware-1.svg){fig-align='center'}\n:::\n:::\n\n\n# Building a forecaster\n\n## Philosophy of forecasting\n\n::: {.fragment .fade-in-then-semi-out}\n\nWe should build up modular components\n\nBe able to add/remove layers of complexity sequentially\n\n:::\n\n::: {.fragment .fade-in-then-semi-out}\n\n  1. [Preprocessor]{.primary}: do things to the data before model training\n  \n  1. [Trainer]{.primary}: train a model on data, resulting in a fitted model object\n\n  1. [Predictor]{.primary}: make predictions, using a fitted model object\n\n  1. [Postprocessor]{.primary}: do things to the predictions before returning\n  \n:::\n\n\n## Examples of preprocessing{.smaller}\n\n::: {.fragment .fade-in-then-semi-out}\n\n### EDA type stuff\n\n1. Making locations/signals commensurate (scaling)\n1. Dealing with revisions \n1. Detecting and removing outliers\n1. Imputing or removing missing data\n\n:::\n\n::: {.fragment .fade-in-then-semi-out}\n\n### Feature engineering\n\n1. Creating lagged predictors\n1. Day of Week effects\n1. Rolling averages for smoothing \n1. Lagged differences\n1. Growth rates instead of raw signals\n1. The sky's the limit\n\n:::\n\n## Examples of postprocessing {.incremental}\n\n* Impute missing features\n* Nowcast current values of features\n* Bootstrap to get predictive intervals\n* Invert scaling or other transforms\n* Threshold predictions, `[0, max_population]`\n\n## Fit a forecaster \n\n\n::: {.cell layout-align=\"center\" hash='day2-afternoon_cache/revealjs/unnamed-chunk-2_43e54e136766eca447ff44f618a52419'}\n\n```{.r .cell-code  code-line-numbers=\"1-6|8-9|11-16|18-20|21-29\"}\n# A preprocessing \"recipe\" that turns raw data into features / response\nr <- epi_recipe(ca) |>\n  step_epi_lag(cases, lag = c(0, 7, 14)) |>\n  step_epi_lag(deaths, lag = c(0, 7, 14)) |>\n  step_epi_ahead(deaths, ahead = 28) |>\n  step_epi_naomit()\n\n# Training engine\ne <- quantile_reg(quantile_levels = c(.1, .5, .9))\n\n# A postprocessing routine describing what to do to the predictions\nf <- frosting() |>\n  layer_predict() |>\n  layer_threshold(.pred, lower = 0) |> # predictions / intervals should be non-negative\n  layer_add_target_date() |>\n  layer_add_forecast_date()\n\n# Bundle up the preprocessor, training engine, and postprocessor\n# We use quantile regression\newf <- epi_workflow(r, e, f)\n\n# Fit it to data (we could fit this to ANY data that has the same format)\ntrained_ewf <- ewf |> fit(ca)\n\n# examines the recipe to determine what we need to make the prediction\nlatest <- get_test_data(r, ca)\n\n# we could make predictions using the same model on ANY test data\npreds <- trained_ewf |> predict(new_data = latest)\n```\n:::\n\n\n\n## Thanks:\n\n\n\n\n\n- The whole [CMU Delphi Team](https://delphi.cmu.edu/about/team/) (across many institutions)\n- Optum/UnitedHealthcare, Change Healthcare.\n- Google, Facebook, Amazon Web Services.\n- Quidel, SafeGraph, Qualtrics.\n- Centers for Disease Control and Prevention.\n- Council of State and Territorial Epidemiologists\n\n\n::: {layout-row=1 fig-align=\"center\"}\n![](gfx/delphi.jpg){height=\"100px\"}\n![](gfx/berkeley.jpg){height=\"100px\"}\n![](gfx/cmu.jpg){height=\"100px\"}\n![](gfx/ubc.jpg){width=\"250px\"}\n![](gfx/stanford.jpg){width=\"250px\"}\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}